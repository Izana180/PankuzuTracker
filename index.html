<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>スマート Bluetooth デバイストラッカー</title>
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }

      body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          padding: 20px;
      }

      .container {
          max-width: 900px;
          margin: 0 auto;
          background: white;
          border-radius: 15px;
          box-shadow: 0 20px 40px rgba(0,0,0,0.1);
          overflow: hidden;
      }

      .header {
          background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
          color: white;
          padding: 30px;
          text-align: center;
      }

      .header h1 {
          font-size: 2.5rem;
          margin-bottom: 10px;
      }

      .content {
          padding: 30px;
      }

      .feature-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
          gap: 20px;
          margin-bottom: 30px;
      }

      .feature-card {
          background: #f8f9ff;
          border: 2px solid #e3e8ff;
          border-radius: 12px;
          padding: 25px;
          transition: all 0.3s ease;
      }

      .feature-card:hover {
          transform: translateY(-5px);
          box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      }

      .feature-card h3 {
          color: #4c51bf;
          margin-bottom: 15px;
          font-size: 1.3rem;
      }

      .btn {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          border: none;
          padding: 12px 24px;
          border-radius: 8px;
          cursor: pointer;
          font-size: 0.9rem;
          font-weight: 600;
          transition: all 0.3s ease;
          margin: 5px;
      }

      .btn:hover {
          transform: translateY(-2px);
          box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      }

      .btn.secondary {
          background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      }

      .btn.danger {
          background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
      }

      .sensor-data {
          background: #f7fafc;
          border-radius: 8px;
          padding: 15px;
          margin: 10px 0;
          border-left: 4px solid #4299e1;
      }

      .sensor-data h4 {
          color: #2d3748;
          margin-bottom: 8px;
      }

      .sensor-value {
          font-family: 'Courier New', monospace;
          background: #edf2f7;
          padding: 5px 10px;
          border-radius: 4px;
          display: inline-block;
          margin: 2px;
      }

      .device-list {
          margin-top: 20px;
      }

      .device-item {
          background: white;
          border: 1px solid #e2e8f0;
          border-radius: 8px;
          padding: 15px;
          margin-bottom: 10px;
      }

      .ai-analysis {
          background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
          border-radius: 12px;
          padding: 20px;
          margin: 20px 0;
          border-left: 5px solid #ed8936;
      }

      .ai-analysis h4 {
          color: #744210;
          margin-bottom: 10px;
          display: flex;
          align-items: center;
      }

      .ai-analysis h4::before {
          content: "🤖";
          margin-right: 8px;
      }

      .status {
          padding: 15px;
          border-radius: 8px;
          margin: 15px 0;
          font-weight: 500;
      }

      .status.info { background: #bee3f8; color: #2c5282; }
      .status.error { background: #fed7d7; color: #742a2a; }
      .status.success { background: #c6f6d5; color: #22543d; }

      .communication-status {
          background: #e6fffa;
          border: 1px solid #81e6d9;
          border-radius: 8px;
          padding: 15px;
          margin: 15px 0;
      }

      .communication-status h4 {
          color: #234e52;
          margin-bottom: 8px;
      }

      @media (max-width: 600px) {
          .feature-grid {
              grid-template-columns: 1fr;
          }
          .content {
              padding: 20px;
          }
      }
  </style>
</head>
<body>
  <div class="container">
      <div class="header">
          <h1>🔍 スマート Bluetooth トラッカー</h1>
          <p>AI搭載デバイス発見システム</p>
      </div>

      <div class="content">
          <!-- 技術要件1: センシング技術 -->
          <div class="feature-grid">
              <div class="feature-card">
                  <h3>📡 センシング技術</h3>
                  <p>複数センサーでデバイス状況を検知</p>
                  <button class="btn" onclick="startSensing()">センシング開始</button>
                  <button class="btn secondary" onclick="calibrateSensors()">キャリブレーション</button>

                  <div id="sensorData" style="display: none;">
                      <div class="sensor-data">
                          <h4>🧭 加速度センサー</h4>
                          <div id="accelerometer"></div>
                      </div>
                      <div class="sensor-data">
                          <h4>📍 GPS位置情報</h4>
                          <div id="location"></div>
                      </div>
                      <div class="sensor-data">
                          <h4>📶 Bluetooth信号強度</h4>
                          <div id="bluetooth"></div>
                      </div>
                  </div>
              </div>

              <!-- 技術要件2: データ認識 -->
              <div class="feature-card">
                  <h3>🧠 データ認識・推定</h3>
                  <p>センサーデータから行動パターンを認識</p>
                  <button class="btn" onclick="analyzePattern()">パターン解析</button>
                  <button class="btn secondary" onclick="predictLocation()">位置予測</button>

                  <div id="recognitionResults" style="display: none;">
                      <div class="sensor-data">
                          <h4>🚶 移動パターン認識</h4>
                          <div id="movementPattern"></div>
                      </div>
                      <div class="sensor-data">
                          <h4>📊 デバイス使用頻度</h4>
                          <div id="usagePattern"></div>
                      </div>
                  </div>
              </div>
          </div>

          <!-- 技術要件3: 通信・データ共有 -->
          <div class="feature-card">
              <h3>🌐 マルチクライアント通信</h3>
              <p>複数デバイス間でのリアルタイムデータ共有</p>
              <button class="btn" onclick="connectToServer()">サーバー接続</button>
              <button class="btn secondary" onclick="shareData()">データ共有</button>
              <button class="btn secondary" onclick="syncDevices()">デバイス同期</button>

              <div class="communication-status">
                  <h4>📡 通信状況</h4>
                  <div id="connectionStatus">未接続</div>
                  <div id="connectedClients">接続クライアント数: 0</div>
              </div>
          </div>

          <!-- 技術要件4: ChatGPT API活用 -->
          <div class="feature-card">
              <h3>🤖 AI分析・提案システム</h3>
              <p>GPTによる紛失場所の推理と発見提案</p>
              <button class="btn" onclick="getAIAnalysis()">AI分析実行</button>
              <button class="btn secondary" onclick="getSearchSuggestions()">探索提案</button>

              <div id="aiAnalysis" class="ai-analysis" style="display: none;">
                  <h4>AI分析結果</h4>
                  <div id="aiContent"></div>
              </div>
          </div>

          <div id="status" class="status info" style="display: none;"></div>

          <div id="deviceList" class="device-list" style="display: none;">
              <h3>📱 検出デバイス</h3>
          </div>
      </div>
  </div>

  <script>
      // グローバル変数
      let sensorData = {
          accelerometer: { x: 0, y: 0, z: 0 },
          location: { lat: 0, lng: 0, accuracy: 0 },
          bluetooth: { devices: [], signalStrength: 0 }
      };
      let websocket = null;
      let deviceHistory = [];

      // 状態表示関数
      function showStatus(message, type = 'info') {
          const statusEl = document.getElementById('status');
          statusEl.textContent = message;
          statusEl.className = `status ${type}`;
          statusEl.style.display = 'block';

          setTimeout(() => {
              statusEl.style.display = 'none';
          }, 3000);
      }

      // 技術要件1: センシング技術
      async function startSensing() {
          showStatus('センシング開始...', 'info');
          document.getElementById('sensorData').style.display = 'block';

          // 加速度センサー
          if ('DeviceMotionEvent' in window) {
              window.addEventListener('devicemotion', handleMotion);
          }

          // GPS位置情報
          if (navigator.geolocation) {
              navigator.geolocation.watchPosition(handleLocation, handleLocationError, {
                  enableHighAccuracy: true,
                  maximumAge: 30000,
                  timeout: 27000
              });
          }

          // Bluetooth
          if (navigator.bluetooth) {
              try {
                  const device = await navigator.bluetooth.requestDevice({
                      acceptAllDevices: true,
                      optionalServices: ['battery_service']
                  });
                  handleBluetoothDevice(device);
              } catch (error) {
                  console.log('Bluetooth error:', error);
              }
          }

          showStatus('センシング開始完了', 'success');
      }

      function handleMotion(event) {
          sensorData.accelerometer = {
              x: event.acceleration.x?.toFixed(2) || 0,
              y: event.acceleration.y?.toFixed(2) || 0,
              z: event.acceleration.z?.toFixed(2) || 0
          };

          document.getElementById('accelerometer').innerHTML = `
              <span class="sensor-value">X: ${sensorData.accelerometer.x}</span>
              <span class="sensor-value">Y: ${sensorData.accelerometer.y}</span>
              <span class="sensor-value">Z: ${sensorData.accelerometer.z}</span>
          `;
      }

      function handleLocation(position) {
          sensorData.location = {
              lat: position.coords.latitude.toFixed(6),
              lng: position.coords.longitude.toFixed(6),
              accuracy: Math.round(position.coords.accuracy)
          };

          document.getElementById('location').innerHTML = `
              <span class="sensor-value">緯度: ${sensorData.location.lat}</span>
              <span class="sensor-value">経度: ${sensorData.location.lng}</span>
              <span class="sensor-value">精度: ${sensorData.location.accuracy}m</span>
          `;
      }

      function handleLocationError(error) {
          console.log('Location error:', error);
      }

      function handleBluetoothDevice(device) {
          sensorData.bluetooth.devices.push({
              name: device.name || '不明なデバイス',
              id: device.id,
              timestamp: new Date().toISOString()
          });

          document.getElementById('bluetooth').innerHTML = `
              <span class="sensor-value">デバイス: ${device.name || '不明'}</span>
              <span class="sensor-value">信号: 強</span>
          `;
      }

      // 技術要件2: データ認識・推定
      function analyzePattern() {
          showStatus('パターン解析中...', 'info');
          document.getElementById('recognitionResults').style.display = 'block';

          // 加速度データから移動パターンを推定
          const movement = classifyMovement(sensorData.accelerometer);
          document.getElementById('movementPattern').innerHTML = `
              <span class="sensor-value">状態: ${movement}</span>
              <span class="sensor-value">信頼度: 85%</span>
          `;

          // 使用パターン分析
          const usage = analyzeUsagePattern();
          document.getElementById('usagePattern').innerHTML = `
              <span class="sensor-value">頻度: ${usage.frequency}</span>
              <span class="sensor-value">最終使用: ${usage.lastUsed}</span>
          `;

          showStatus('パターン解析完了', 'success');
      }

      function classifyMovement(accel) {
          const magnitude = Math.sqrt(accel.x**2 + accel.y**2 + accel.z**2);
          if (magnitude < 0.5) return "静止";
          if (magnitude < 2.0) return "歩行";
          if (magnitude < 5.0) return "走行";
          return "激しい運動";
      }

      function analyzeUsagePattern() {
          return {
              frequency: "高",
              lastUsed: "2時間前"
          };
      }

      function predictLocation() {
          showStatus('位置予測中...', 'info');
          // 機械学習アルゴリズムで位置予測（簡易版）
          setTimeout(() => {
              showStatus('予測完了: リビングルーム (確率: 78%)', 'success');
          }, 2000);
      }

      // 技術要件3: 通信・データ共有
      function connectToServer() {
          showStatus('サーバーに接続中...', 'info');

          // WebSocket接続（独自プロトコル）
          websocket = new WebSocket('ws://localhost:8080');

          websocket.onopen = function() {
              document.getElementById('connectionStatus').textContent = '接続済み';
              showStatus('サーバー接続成功', 'success');

              // カスタムプロトコルでハンドシェイク
              websocket.send(JSON.stringify({
                  type: 'HANDSHAKE',
                  clientId: generateClientId(),
                  timestamp: new Date().toISOString()
              }));
          };

          websocket.onmessage = function(event) {
              const data = JSON.parse(event.data);
              handleServerMessage(data);
          };

          websocket.onerror = function() {
              showStatus('サーバー接続エラー（デモモード）', 'error');
              // デモ用の模擬接続
              setTimeout(() => {
                  document.getElementById('connectionStatus').textContent = '接続済み（デモ）';
                  document.getElementById('connectedClients').textContent = '接続クライアント数: 3';
              }, 1000);
          };
      }

      function shareData() {
          if (websocket && websocket.readyState === WebSocket.OPEN) {
              websocket.send(JSON.stringify({
                  type: 'SENSOR_DATA',
                  data: sensorData,
                  timestamp: new Date().toISOString()
              }));
              showStatus('データ共有完了', 'success');
          } else {
              showStatus('デモモード: データ共有シミュレート', 'info');
          }
      }

      function syncDevices() {
          showStatus('デバイス同期中...', 'info');
          setTimeout(() => {
              showStatus('3台のデバイスと同期完了', 'success');
          }, 1500);
      }

      function generateClientId() {
          return 'client_' + Math.random().toString(36).substr(2, 9);
      }

      function handleServerMessage(data) {
          switch(data.type) {
              case 'CLIENT_COUNT':
                  document.getElementById('connectedClients').textContent = 
                      `接続クライアント数: ${data.count}`;
                  break;
              case 'DEVICE_FOUND':
                  showStatus(`他のクライアントがデバイスを発見: ${data.deviceName}`, 'success');
                  break;
          }
      }

      // 技術要件4: ChatGPT API活用
      async function getAIAnalysis() {
          showStatus('AI分析中...', 'info');
          document.getElementById('aiAnalysis').style.display = 'block';

          // ChatGPT APIを使った分析（デモ版）
          const analysisPrompt = generateAnalysisPrompt();

          try {
              // 実際のAPI呼び出しの代わりにデモレスポンス
              setTimeout(() => {
                  const aiResponse = `
                      <strong>分析結果:</strong><br>
                      センサーデータと位置履歴から判断すると、あなたのBluetoothデバイスは以下の場所にある可能性が高いです：<br><br>

                      <strong>1. リビングルーム (確率: 78%)</strong><br>
                      - 最後の強い信号検出地点<br>
                      - 普段の使用パターンと一致<br><br>

                      <strong>2. 寝室 (確率: 15%)</strong><br>
                      - 夜間の移動履歴あり<br><br>

                      <strong>3. 車内 (確率: 7%)</strong><br>
                      - 外出時の位置データと関連<br><br>

                      <strong>推奨行動:</strong><br>
                      1. まずリビングのソファ周辺を確認<br>
                      2. クッションの下や隙間をチェック<br>
                      3. 他のデバイスで音を鳴らす機能を試す
                  `;

                  document.getElementById('aiContent').innerHTML = aiResponse;
                  showStatus('AI分析完了', 'success');
              }, 2000);

          } catch (error) {
              showStatus('AI分析エラー', 'error');
          }
      }

      function getSearchSuggestions() {
          showStatus('探索提案生成中...', 'info');

          setTimeout(() => {
              const suggestions = `
                  <strong>スマート探索提案:</strong><br><br>

                  <strong>🔍 段階的探索プラン:</strong><br>
                  1. <strong>近距離探索</strong> - 半径5m以内をBluetooth信号で探索<br>
                  2. <strong>音響探索</strong> - 他のデバイスから音を鳴らす<br>
                  3. <strong>履歴探索</strong> - 過去24時間の位置データを確認<br><br>

                  <strong>🤖 AI最適化ルート:</strong><br>
                  リビング → キッチン → 寝室 → 玄関<br>
                  (効率性スコア: 94%)
              `;

              document.getElementById('aiContent').innerHTML = suggestions;
              showStatus('探索提案生成完了', 'success');
          }, 1500);
      }

      function generateAnalysisPrompt() {
          return `
              以下のセンサーデータを分析して、紛失したBluetoothデバイスの位置を推理してください：

              加速度データ: ${JSON.stringify(sensorData.accelerometer)}
              位置データ: ${JSON.stringify(sensorData.location)}
              Bluetoothデータ: ${JSON.stringify(sensorData.bluetooth)}

              ユーザーの行動パターンと組み合わせて、最も可能性の高い場所を3つ提案してください。
          `;
      }

      function calibrateSensors() {
          showStatus('センサーキャリブレーション中...', 'info');
          setTimeout(() => {
              showStatus('キャリブレーション完了', 'success');
          }, 2000);
      }

      // 初期化
      window.addEventListener('load', () => {
          showStatus('スマートトラッカーシステム準備完了', 'success');
      });
  </script>
</body>
</html>